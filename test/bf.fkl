(import (.. lib utils m))

(define code "++++++++++[>+++++++>++++++++++>+++>+<<<<-]>++.>+.+++++++..+++.>++.<<+++++++++++++++.>.+++.------.--------.>+.>.")

(define m #(0))

(define len (length code))

(define stack nil)
(let iter ((cp 0)
           (mp 0))
  (when (< cp len)
    (define op (str-ref code cp))
    (cond
      [(eq op #\>)
       (setq mp (1+ mp))
       (if (>= mp (length m))
         (append! m #(0)))]
      [(eq op #\<)
       (if (<= mp 0)
         (setq m (append! #(0) m))
         (setq mp (-1+ mp)))]
      [(eq op #\+)
       (define c (vec-ref m mp))
       (vec-set! m mp (1+ c))]
      [(eq op #\-)
       (define c (vec-ref m mp))
       (vec-set! m mp (-1+ c))]
      [(eq op #\.)
       (princ (integer->char (vec-ref m mp)))]
      [(eq op #\,)
       (vec-set! m mp (fgeti stdin))]
      [(eq op #\[)
       (setq stack (cons cp stack))]
      [(eq op #\])
       (if (> (vec-ref m mp) 0)
         (setq cp (car stack))
         (setq stack (cdr stack)))]
      [1 (setq cp (1+ cp))])
    (iter (1+ cp) mp)))
