(import (prefix (.. lib fuv) uv-))

(import (only (.. lib utils m) assert))

(define loop (uv-make-loop))

(define timer (uv-make-timer loop))

(define prepare (uv-make-prepare loop))

(println (uv-handle-type timer))
(println (uv-handle-type prepare))

(uv-timer-start! timer
                 (lambda ()
                   (println "time out!")
                   (uv-timer-stop! timer)
                   (uv-handle-close! timer (lambda () (println "timer closing!"))))
                 50
                 500)

(define flags 'prepare)

(uv-prepare-start! prepare
                   (lambda ()
                     (assert (eq flags 'prepare))
                     (println "preparing!")
                     (uv-prepare-stop! prepare)
                     (uv-handle-close! prepare (lambda () (println "prepare closing!")))
                     (setq flags 'idle)))

(uv-loop-walk loop println)

(uv-loop-run! loop 'default)

(define timer (uv-make-timer loop))

(uv-timer-start! timer
                 (lambda ()
                   (println "time out again!")
                   (uv-loop-stop! loop)
                   (println "stop the loop!"))
                 50
                 500)

(uv-loop-configure! loop 'loop-block-signal 'sigprof)
(uv-loop-configure! loop 'metrics-idle-time)

(uv-loop-walk loop println)

(uv-loop-run! loop)

(uv-handle-close! timer)

(define timer (uv-make-timer loop))

(define count 0)

(uv-timer-start! timer
                 (lambda ()
                   (printf "count is %d\n" count)
                   (setq count (1+ count))
                   (when (> count 9)
                     (uv-handle-close! timer)))
                 50
                 50)

(uv-loop-run! loop)

(printf "count is %d in top\n" count)
