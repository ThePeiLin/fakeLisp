(import (prefix (.. .. lib fuv) uv-))

(import (only (.. .. lib utils m) assert))

(define loop (uv-make-loop))

(define tcp (uv-make-tcp loop))

(assert (uv-tcp? tcp))
(assert (uv-stream? tcp))
(assert (uv-handle? tcp))

(uv-tcp-nodelay tcp 1)
(uv-tcp-simultaneous-accepts tcp 1)
(assert (eq (error-type (prin1n (pcall uv-tcp-keepalive tcp 1)))
            'arg-error))
(assert (eq (error-type (prin1n (pcall uv-tcp-keepalive tcp nil 114)))
            'arg-error))
(uv-tcp-keepalive tcp 1 114)

(define socketpair (uv-socketpair 'stream nil 1 1))
(prin1n socketpair)

(define tcp (uv-make-tcp loop))

(uv-tcp-open tcp (cdr socketpair))

(prin1n (uv-tcp-sockname tcp))

(prin1n (uv-tcp-peername tcp))

(uv-tcp-close-reset tcp
                    (lambda ()
                      (assert (uv-handle-closing? tcp))))

(uv-loop-run loop)

(define server (uv-make-tcp loop))

(uv-tcp-bind server "127.0.0.1" 0)

(define (on-connection err)
  (assert (not err))
  (uv-handle-close server))

(uv-stream-listen server
                  128
                  on-connection)

(define addr (uv-tcp-sockname server))

(printf "server=%S, address=%S\n" server addr)
